{% extends 'app/layout.html' %}
{% block content %}
<script>
    // Fetch tasks data from the server
    fetch('/task-json/')
        .then(response => response.json())
        .then(tasks => {
            console.log(tasks);
            // Check if the browser supports notifications
            if (!("Notification" in window)) {
                alert("This browser does not support desktop notification");
            }

            // Let's check whether notification permissions have already been granted
            else if (Notification.permission === "granted") {
                // If it's okay let's create a notification
                notifyTasks(tasks);
            }

            // Otherwise, we need to ask the user for permission
            else if (Notification.permission !== 'denied') {
                Notification.requestPermission().then(function (permission) {
                    // If the user accepts, let's create a notification
                    if (permission === "granted") {
                        notifyTasks(tasks);
                    }
                });
            }
        });

    function notifyTasks(tasks) {
        tasks.forEach(task => {
            // Check if the due date is within 2 days
            let dueDate = new Date(task.fields.due_date);
            let now = new Date();
            let diffTime = Math.abs(dueDate - now);
            let diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            console.log(`Due date for task ${task.fields.title}: ${task.fields.due_date}`);
            console.log(`Days until due date: ${diffDays}`);
            if (diffDays <= 2) {
                var notification = new Notification(`Task ${task.fields.title} is due in ${diffDays} days`);
            }
        });
    }
</script>
<div class="header-bar">
    <div>
        <h3 style="margin:0">You have <i>{{ count }}</i> incomplete task{{ count|pluralize:"s" }}.</h3>
    </div>
    {% if request.user.is_authenticated %}
    <!--<p>{{ request.user }}</p>-->
    <!--<a href="{% url 'logout' %}">Logout</a>-->
    {% else %}
    <a href="{% url 'login' %}">Login</a> | <a href="{% url 'register' %}">Register</a>
    {% endif %}
</div>
<hr>
<!-- Search form -->
<div id="search-add-wrapper">
    <form method="GET" style="margin-top: 20px; display: flex;">
        <input type="text" name='search-area' value="{{ search_input }}" placeholder="Search for your task.." />
        <input class="button" type="submit" value='Search' />
    </form>
    <a id="add-link" href="{% url 'task-create' %}">&#x2b;</a>
</div>
<div class="task-items-wrapper">
    {% for date, tasks in tasks_by_date.items %}
    <h2>{{ date }}</h2>
    {% for task in tasks %}
    <div class="task-wrapper">
        {% if task.complete %}
        <!-- Complete Tasks -->
        <table>
            <tr>
                <td style="text-align: left;">
                    <div class="task-complete-icon"></div>
                </td>
                <td style="text-align: left; max-width: 20em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    <i><s><a href="{% url 'task-update' task.id %}">{{ task }}</a></s></i>
                </td>
                <td style="width: 300px;"></td> <!-- td spacer -->
                <td style="width: 300px;"></td> <!-- td spacer -->
                <td style="width: 600px; text-align: right;">
                    <div class="delete-link">
                        <a class="fa fa-eye" href="{% url 'task' task.id %}" style="text-decoration: none"></a>
                        <a href="{% url 'task-delete' task.id %}" style="text-decoration: none">&#215;</a>
                    </div>
                </td>
            </tr>
        </table>
        {% else %}
        <!-- Incomplete Tasks -->
        <table>
            <tr>
                <td style="text-align: left;">
                    <div class="task-incomplete-icon"></div>
                </td>
                <td style="text-align: left; max-width: 20em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    <a href="{% url 'task-update' task.id %}">{{ task }}</a>
                </td>
                <td style="width: 300px; text-align: left; word-wrap: break-word;">
                    <span class="task-priority">Priority: {{ task.get_priority_display }}</span>
                </td>
                <td style="width: 300px; text-align: left; word-wrap: break-word;">
                    <span class="timer"><b>Due: </b>{{ task.due_date|timeuntil }}</span>
                </td>
                <td style="width: 600px; text-align: right;">
                    <div class="delete-link">
                        <a class="fa fa-eye" href="{% url 'task' task.id %}" style="text-decoration: none"></a>
                        <a href="{% url 'task-delete' task.id %}" style="text-decoration: none">&#215;</a>
                    </div>
                </td>
            </tr>
        </table>
        {% endif %}
    </div>
    {% endfor %}
    {% empty %}
    <h2>No items in list</h2>
    {% endfor %}
</div>
{% endblock content %}