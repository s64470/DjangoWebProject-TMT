{% extends 'app/layout.html' %}
{% block content %}
<script>
    // Fetch tasks data from the server for the logged in user
    fetch('/task-json/')
        .then(response => response.json())
        .then(tasks => {
            console.log(tasks);
            // Check if the browser supports notifications
            if (!("Notification" in window)) {
                alert("This browser does not support desktop notification");
            }

            // Let's check whether notification permissions have already been granted
            else if (Notification.permission === "granted") {
                // If it's okay let's create a notification
                if(!localStorage.getItem('notification')){
                    notifyTasks(tasks);
                    localStorage.setItem('notification', 'true');
                }
            }

            // Otherwise, we need to ask the user for permission
            else if (Notification.permission !== 'denied') {
                Notification.requestPermission().then(function (permission) {
                    // If the user accepts, let's create a notification
                    if (permission === "granted") {
                        notifyTasks(tasks);
                        localStorage.setItem('notification', 'true');
                    }
                });
            }
        });

    function notifyTasks(tasks) {
        tasks.forEach(task => {
            // Check if the due date is within 2 days
            let dueDate = new Date(task.fields.due_date);
            let now = new Date();
            let diffTime = Math.abs(dueDate - now);
            let diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            if (diffDays <= 2) {
                var notification = new Notification(`Task ${task.fields.title} is due in ${diffDays} days`);
            }
        });
    }

    // Add event listener for logout button
    window.addEventListener('load', function() {
        var logoutForm = document.getElementById('logoutForm');
        if (logoutForm) {
            logoutForm.addEventListener('click', function() {
                localStorage.removeItem('notification');
            });
        }
    });
</script>
<div class="header-bar">
    <div>
        <h3 style="margin:0">You have <i>{{ count }}</i> incomplete task{{ count|pluralize:"s" }}.</h3>
    </div>
    {% if request.user.is_authenticated %}
    <!--<p>{{ request.user }}</p>-->
    <!--<a href="{% url 'logout' %}">Logout</a>-->
    {% else %}
    <a href="{% url 'login' %}">Login</a> | <a href="{% url 'register' %}">Register</a>
    {% endif %}
</div>
<hr>
<!-- Search form -->
<div id="search-add-wrapper">
    <form method="GET" style="margin-top: 20px; display: flex;">
        <input type="text" name='search-area' value="{{ search_input }}" placeholder="Search for your task.." />
        <input class="button" type="submit" value='Search' />
    </form>
    <a id="add-link" href="{% url 'task-create' %}">&#x2b;</a>
</div>
<div class="task-items-wrapper">
    {% for date, tasks in tasks_by_date.items %}
    <h2>{{ date }}</h2>
    {% for task in tasks %}
    <div class="task-wrapper">
        {% if task.complete %}
        <!-- Complete Tasks -->
        <table>
            <tr>
                <!-- Task icon -->
                <td style="text-align: left;">
                    <div class="task-complete-icon"></div>
                </td>
                <!-- Task name -->
                <td style="text-align: left; max-width: 20em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    <i><s><a href="{% url 'task-update' task.id %}">{{ task }}</a></s></i>
                </td>
            <tr>
                <td style="width: 20em;"></td>
            </tr>
            <!-- Task priority (empty space) -->
            <td style="width: 300px;"></td> <!-- td space -->
            <!-- Task due date (empty space) -->
            <td style="width: 300px;"></td> <!-- td space -->
            <!-- Task view, delete icon -->
            <td style="width: 600px; text-align: right;">
                <div class="delete-link">
                    <a class="fa fa-eye" href="{% url 'task' task.id %}" style="text-decoration: none"></a>
                    <a href="{% url 'task-delete' task.id %}" style="text-decoration: none">&#215;</a>
                </div>
            </td>
            </tr>
        </table>
        {% else %}
        <!-- Incomplete Tasks -->
        <table>
            <tr>
                <!-- Task icon -->
                <td style="text-align: left;">
                    <div class="task-incomplete-icon"></div>
                </td>
                <!-- Task name -->
                <td style="text-align: left; max-width: 20em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    <a href="{% url 'task-update' task.id %}">{{ task }}</a>
                </td>
            </tr>
            <tr>
                <td style="width: 20em;"></td>
            </tr>
            <tr>
                <!-- Task priority -->
                <td style="text-align: left; word-wrap: break-word; padding-left: 5em;">
                    <span class="task-priority">Priority: {{ task.get_priority_display }}</span>
                </td>
                <!-- Task due date -->
                <td style="width: 300px; text-align: left; word-wrap: break-word; padding-left: 0em;">
                    <span class="timer"><b>Due: </b>{{ task.due_date|timeuntil }}</span>
                </td>
                <!-- Task view, delete icon -->
                <td style="width: 600px; text-align: right;">
                    <div class="delete-link">
                        <a class="fa fa-eye" href="{% url 'task' task.id %}" style="text-decoration: none"></a>
                        <a href="{% url 'task-delete' task.id %}" style="text-decoration: none">&#215;</a>
                    </div>
                </td>
            </tr>
        </table>
        {% endif %}
    </div>
    {% endfor %}
    {% empty %}
    <h2>No items in list</h2>
    {% endfor %}
</div>
{% endblock content %}